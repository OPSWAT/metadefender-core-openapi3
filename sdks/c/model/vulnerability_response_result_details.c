#include <stdlib.h>
#include <string.h>
#include <stdio.h>
#include "vulnerability_response_result_details.h"



vulnerability_response_result_details_t *vulnerability_response_result_details_create(
    char *cpe,
    char *cve,
    vulnerability_response_result_details_cvss_t *cvss,
    char *cwe,
    char *last_modified_epoch,
    char *published_epoch,
    list_t *references
    ) {
    vulnerability_response_result_details_t *vulnerability_response_result_details_local_var = malloc(sizeof(vulnerability_response_result_details_t));
    if (!vulnerability_response_result_details_local_var) {
        return NULL;
    }
    vulnerability_response_result_details_local_var->cpe = cpe;
    vulnerability_response_result_details_local_var->cve = cve;
    vulnerability_response_result_details_local_var->cvss = cvss;
    vulnerability_response_result_details_local_var->cwe = cwe;
    vulnerability_response_result_details_local_var->last_modified_epoch = last_modified_epoch;
    vulnerability_response_result_details_local_var->published_epoch = published_epoch;
    vulnerability_response_result_details_local_var->references = references;

    return vulnerability_response_result_details_local_var;
}


void vulnerability_response_result_details_free(vulnerability_response_result_details_t *vulnerability_response_result_details) {
    if(NULL == vulnerability_response_result_details){
        return ;
    }
    listEntry_t *listEntry;
    free(vulnerability_response_result_details->cpe);
    free(vulnerability_response_result_details->cve);
    vulnerability_response_result_details_cvss_free(vulnerability_response_result_details->cvss);
    free(vulnerability_response_result_details->cwe);
    free(vulnerability_response_result_details->last_modified_epoch);
    free(vulnerability_response_result_details->published_epoch);
    list_ForEach(listEntry, vulnerability_response_result_details->references) {
        free(listEntry->data);
    }
    list_free(vulnerability_response_result_details->references);
    free(vulnerability_response_result_details);
}

cJSON *vulnerability_response_result_details_convertToJSON(vulnerability_response_result_details_t *vulnerability_response_result_details) {
    cJSON *item = cJSON_CreateObject();

    // vulnerability_response_result_details->cpe
    if(vulnerability_response_result_details->cpe) { 
    if(cJSON_AddStringToObject(item, "cpe", vulnerability_response_result_details->cpe) == NULL) {
    goto fail; //String
    }
     } 


    // vulnerability_response_result_details->cve
    if(vulnerability_response_result_details->cve) { 
    if(cJSON_AddStringToObject(item, "cve", vulnerability_response_result_details->cve) == NULL) {
    goto fail; //String
    }
     } 


    // vulnerability_response_result_details->cvss
    if(vulnerability_response_result_details->cvss) { 
    cJSON *cvss_local_JSON = vulnerability_response_result_details_cvss_convertToJSON(vulnerability_response_result_details->cvss);
    if(cvss_local_JSON == NULL) {
    goto fail; //model
    }
    cJSON_AddItemToObject(item, "cvss", cvss_local_JSON);
    if(item->child == NULL) {
    goto fail;
    }
     } 


    // vulnerability_response_result_details->cwe
    if(vulnerability_response_result_details->cwe) { 
    if(cJSON_AddStringToObject(item, "cwe", vulnerability_response_result_details->cwe) == NULL) {
    goto fail; //String
    }
     } 


    // vulnerability_response_result_details->last_modified_epoch
    if(vulnerability_response_result_details->last_modified_epoch) { 
    if(cJSON_AddStringToObject(item, "last_modified_epoch", vulnerability_response_result_details->last_modified_epoch) == NULL) {
    goto fail; //String
    }
     } 


    // vulnerability_response_result_details->published_epoch
    if(vulnerability_response_result_details->published_epoch) { 
    if(cJSON_AddStringToObject(item, "published-epoch", vulnerability_response_result_details->published_epoch) == NULL) {
    goto fail; //String
    }
     } 


    // vulnerability_response_result_details->references
    if(vulnerability_response_result_details->references) { 
    cJSON *references = cJSON_AddArrayToObject(item, "references");
    if(references == NULL) {
        goto fail; //primitive container
    }

    listEntry_t *referencesListEntry;
    list_ForEach(referencesListEntry, vulnerability_response_result_details->references) {
    if(cJSON_AddStringToObject(references, "", (char*)referencesListEntry->data) == NULL)
    {
        goto fail;
    }
    }
     } 

    return item;
fail:
    if (item) {
        cJSON_Delete(item);
    }
    return NULL;
}

vulnerability_response_result_details_t *vulnerability_response_result_details_parseFromJSON(cJSON *vulnerability_response_result_detailsJSON){

    vulnerability_response_result_details_t *vulnerability_response_result_details_local_var = NULL;

    // vulnerability_response_result_details->cpe
    cJSON *cpe = cJSON_GetObjectItemCaseSensitive(vulnerability_response_result_detailsJSON, "cpe");
    if (cpe) { 
    if(!cJSON_IsString(cpe))
    {
    goto end; //String
    }
    }

    // vulnerability_response_result_details->cve
    cJSON *cve = cJSON_GetObjectItemCaseSensitive(vulnerability_response_result_detailsJSON, "cve");
    if (cve) { 
    if(!cJSON_IsString(cve))
    {
    goto end; //String
    }
    }

    // vulnerability_response_result_details->cvss
    cJSON *cvss = cJSON_GetObjectItemCaseSensitive(vulnerability_response_result_detailsJSON, "cvss");
    vulnerability_response_result_details_cvss_t *cvss_local_nonprim = NULL;
    if (cvss) { 
    cvss_local_nonprim = vulnerability_response_result_details_cvss_parseFromJSON(cvss); //nonprimitive
    }

    // vulnerability_response_result_details->cwe
    cJSON *cwe = cJSON_GetObjectItemCaseSensitive(vulnerability_response_result_detailsJSON, "cwe");
    if (cwe) { 
    if(!cJSON_IsString(cwe))
    {
    goto end; //String
    }
    }

    // vulnerability_response_result_details->last_modified_epoch
    cJSON *last_modified_epoch = cJSON_GetObjectItemCaseSensitive(vulnerability_response_result_detailsJSON, "last_modified_epoch");
    if (last_modified_epoch) { 
    if(!cJSON_IsString(last_modified_epoch))
    {
    goto end; //String
    }
    }

    // vulnerability_response_result_details->published_epoch
    cJSON *published_epoch = cJSON_GetObjectItemCaseSensitive(vulnerability_response_result_detailsJSON, "published-epoch");
    if (published_epoch) { 
    if(!cJSON_IsString(published_epoch))
    {
    goto end; //String
    }
    }

    // vulnerability_response_result_details->references
    cJSON *references = cJSON_GetObjectItemCaseSensitive(vulnerability_response_result_detailsJSON, "references");
    list_t *referencesList;
    if (references) { 
    cJSON *references_local;
    if(!cJSON_IsArray(references)) {
        goto end;//primitive container
    }
    referencesList = list_create();

    cJSON_ArrayForEach(references_local, references)
    {
        if(!cJSON_IsString(references_local))
        {
            goto end;
        }
        list_addElement(referencesList , strdup(references_local->valuestring));
    }
    }


    vulnerability_response_result_details_local_var = vulnerability_response_result_details_create (
        cpe ? strdup(cpe->valuestring) : NULL,
        cve ? strdup(cve->valuestring) : NULL,
        cvss ? cvss_local_nonprim : NULL,
        cwe ? strdup(cwe->valuestring) : NULL,
        last_modified_epoch ? strdup(last_modified_epoch->valuestring) : NULL,
        published_epoch ? strdup(published_epoch->valuestring) : NULL,
        references ? referencesList : NULL
        );

    return vulnerability_response_result_details_local_var;
end:
    return NULL;

}
