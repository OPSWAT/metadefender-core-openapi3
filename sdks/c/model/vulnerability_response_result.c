#include <stdlib.h>
#include <string.h>
#include <stdio.h>
#include "vulnerability_response_result.h"


char* methodvulnerability_response_result_ToString(metadefender_core_vulnerability_response_result_METHOD_e method) {
    char* methodArray[] =  { "NULL", "_50700" };
	return methodArray[method];
}

metadefender_core_vulnerability_response_result_METHOD_e methodvulnerability_response_result_FromString(char* method){
    int stringToReturn = 0;
    char *methodArray[] =  { "NULL", "_50700" };
    size_t sizeofArray = sizeof(methodArray) / sizeof(methodArray[0]);
    while(stringToReturn < sizeofArray) {
        if(strcmp(method, methodArray[stringToReturn]) == 0) {
            return stringToReturn;
        }
        stringToReturn++;
    }
    return 0;
}

vulnerability_response_result_t *vulnerability_response_result_create(
    int code,
    char *hash,
    int method,
    char *timestamp,
    int timing,
    vulnerability_response_result_detected_product_t *detected_product,
    list_t *vulnerabilites
    ) {
    vulnerability_response_result_t *vulnerability_response_result_local_var = malloc(sizeof(vulnerability_response_result_t));
    if (!vulnerability_response_result_local_var) {
        return NULL;
    }
    vulnerability_response_result_local_var->code = code;
    vulnerability_response_result_local_var->hash = hash;
    vulnerability_response_result_local_var->method = method;
    vulnerability_response_result_local_var->timestamp = timestamp;
    vulnerability_response_result_local_var->timing = timing;
    vulnerability_response_result_local_var->detected_product = detected_product;
    vulnerability_response_result_local_var->vulnerabilites = vulnerabilites;

    return vulnerability_response_result_local_var;
}


void vulnerability_response_result_free(vulnerability_response_result_t *vulnerability_response_result) {
    if(NULL == vulnerability_response_result){
        return ;
    }
    listEntry_t *listEntry;
    free(vulnerability_response_result->hash);
    free(vulnerability_response_result->timestamp);
    vulnerability_response_result_detected_product_free(vulnerability_response_result->detected_product);
    list_ForEach(listEntry, vulnerability_response_result->vulnerabilites) {
        vulnerability_response_result_vulnerabilites_free(listEntry->data);
    }
    list_free(vulnerability_response_result->vulnerabilites);
    free(vulnerability_response_result);
}

cJSON *vulnerability_response_result_convertToJSON(vulnerability_response_result_t *vulnerability_response_result) {
    cJSON *item = cJSON_CreateObject();

    // vulnerability_response_result->code
    if(vulnerability_response_result->code) { 
    if(cJSON_AddNumberToObject(item, "code", vulnerability_response_result->code) == NULL) {
    goto fail; //Numeric
    }
     } 


    // vulnerability_response_result->hash
    if(vulnerability_response_result->hash) { 
    if(cJSON_AddStringToObject(item, "hash", vulnerability_response_result->hash) == NULL) {
    goto fail; //String
    }
     } 


    // vulnerability_response_result->method
    
    if(cJSON_AddNumberToObject(item, "method", vulnerability_response_result->method) == NULL) {
    goto fail; //Numeric
    }
    


    // vulnerability_response_result->timestamp
    if(vulnerability_response_result->timestamp) { 
    if(cJSON_AddStringToObject(item, "timestamp", vulnerability_response_result->timestamp) == NULL) {
    goto fail; //String
    }
     } 


    // vulnerability_response_result->timing
    if(vulnerability_response_result->timing) { 
    if(cJSON_AddNumberToObject(item, "timing", vulnerability_response_result->timing) == NULL) {
    goto fail; //Numeric
    }
     } 


    // vulnerability_response_result->detected_product
    if(vulnerability_response_result->detected_product) { 
    cJSON *detected_product_local_JSON = vulnerability_response_result_detected_product_convertToJSON(vulnerability_response_result->detected_product);
    if(detected_product_local_JSON == NULL) {
    goto fail; //model
    }
    cJSON_AddItemToObject(item, "detected_product", detected_product_local_JSON);
    if(item->child == NULL) {
    goto fail;
    }
     } 


    // vulnerability_response_result->vulnerabilites
    if(vulnerability_response_result->vulnerabilites) { 
    cJSON *vulnerabilites = cJSON_AddArrayToObject(item, "vulnerabilites");
    if(vulnerabilites == NULL) {
    goto fail; //nonprimitive container
    }

    listEntry_t *vulnerabilitesListEntry;
    if (vulnerability_response_result->vulnerabilites) {
    list_ForEach(vulnerabilitesListEntry, vulnerability_response_result->vulnerabilites) {
    cJSON *itemLocal = vulnerability_response_result_vulnerabilites_convertToJSON(vulnerabilitesListEntry->data);
    if(itemLocal == NULL) {
    goto fail;
    }
    cJSON_AddItemToArray(vulnerabilites, itemLocal);
    }
    }
     } 

    return item;
fail:
    if (item) {
        cJSON_Delete(item);
    }
    return NULL;
}

vulnerability_response_result_t *vulnerability_response_result_parseFromJSON(cJSON *vulnerability_response_resultJSON){

    vulnerability_response_result_t *vulnerability_response_result_local_var = NULL;

    // vulnerability_response_result->code
    cJSON *code = cJSON_GetObjectItemCaseSensitive(vulnerability_response_resultJSON, "code");
    if (code) { 
    if(!cJSON_IsNumber(code))
    {
    goto end; //Numeric
    }
    }

    // vulnerability_response_result->hash
    cJSON *hash = cJSON_GetObjectItemCaseSensitive(vulnerability_response_resultJSON, "hash");
    if (hash) { 
    if(!cJSON_IsString(hash))
    {
    goto end; //String
    }
    }

    // vulnerability_response_result->method
    cJSON *method = cJSON_GetObjectItemCaseSensitive(vulnerability_response_resultJSON, "method");
    if (method) { 
    if(!cJSON_IsNumber(method))
    {
    goto end; //Numeric
    }
    }

    // vulnerability_response_result->timestamp
    cJSON *timestamp = cJSON_GetObjectItemCaseSensitive(vulnerability_response_resultJSON, "timestamp");
    if (timestamp) { 
    if(!cJSON_IsString(timestamp))
    {
    goto end; //String
    }
    }

    // vulnerability_response_result->timing
    cJSON *timing = cJSON_GetObjectItemCaseSensitive(vulnerability_response_resultJSON, "timing");
    if (timing) { 
    if(!cJSON_IsNumber(timing))
    {
    goto end; //Numeric
    }
    }

    // vulnerability_response_result->detected_product
    cJSON *detected_product = cJSON_GetObjectItemCaseSensitive(vulnerability_response_resultJSON, "detected_product");
    vulnerability_response_result_detected_product_t *detected_product_local_nonprim = NULL;
    if (detected_product) { 
    detected_product_local_nonprim = vulnerability_response_result_detected_product_parseFromJSON(detected_product); //nonprimitive
    }

    // vulnerability_response_result->vulnerabilites
    cJSON *vulnerabilites = cJSON_GetObjectItemCaseSensitive(vulnerability_response_resultJSON, "vulnerabilites");
    list_t *vulnerabilitesList;
    if (vulnerabilites) { 
    cJSON *vulnerabilites_local_nonprimitive;
    if(!cJSON_IsArray(vulnerabilites)){
        goto end; //nonprimitive container
    }

    vulnerabilitesList = list_create();

    cJSON_ArrayForEach(vulnerabilites_local_nonprimitive,vulnerabilites )
    {
        if(!cJSON_IsObject(vulnerabilites_local_nonprimitive)){
            goto end;
        }
        vulnerability_response_result_vulnerabilites_t *vulnerabilitesItem = vulnerability_response_result_vulnerabilites_parseFromJSON(vulnerabilites_local_nonprimitive);

        list_addElement(vulnerabilitesList, vulnerabilitesItem);
    }
    }


    vulnerability_response_result_local_var = vulnerability_response_result_create (
        code ? code->valuedouble : 0,
        hash ? strdup(hash->valuestring) : NULL,
        method ? method->valuedouble : 0,
        timestamp ? strdup(timestamp->valuestring) : NULL,
        timing ? timing->valuedouble : 0,
        detected_product ? detected_product_local_nonprim : NULL,
        vulnerabilites ? vulnerabilitesList : NULL
        );

    return vulnerability_response_result_local_var;
end:
    return NULL;

}
